@{
    ViewData["Title"] = "Báo cáo kết quả khảo sát";
    var surveyId = ViewBag.SurveyId;
}

<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-chart-bar"></i> Báo cáo kết quả khảo sát</h2>
            <div>
                <button type="button" class="btn btn-success me-2" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i> Xuất Excel
                </button>
                <a href="@Url.Action("Details", "Surveys", new { id = surveyId })" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Quay lại
                </a>
            </div>
        </div>

        <div id="loadingSpinner" class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Đang tải...</span>
            </div>
            <p class="mt-2">Đang tải báo cáo...</p>
        </div>

        <div id="reportContainer" style="display: none;">
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-primary" id="totalResponses">0</h3>
                            <p class="mb-0">Tổng lượt làm</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-success" id="completedResponses">0</h3>
                            <p class="mb-0">Hoàn thành</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-info" id="averageTime">0</h3>
                            <p class="mb-0">Thời gian TB</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-warning" id="responseRate">0%</h3>
                            <p class="mb-0">Tỷ lệ phản hồi</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-poll"></i> Thống kê theo câu hỏi</h5>
                </div>
                <div class="card-body">
                    <div id="questionStatsContainer">
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-list"></i> Danh sách phản hồi</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped" id="responsesTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>STT</th>
                                    <th>Người dùng</th>
                                    <th>Thời gian hoàn thành</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="responsesTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        $(document).ready(function() {
            const surveyId = @surveyId;
            loadSurveyReport(surveyId);
        });

        function displaySurveyReport(report) {
            $('#totalResponses').text(report.totalResponses);
            $('#completedResponses').text(report.completedResponses);
            $('#averageTime').text(report.averageTime + ' phút');
            $('#responseRate').text(report.responseRate + '%');

            displayQuestionStats(report.questionStats);
            displayResponsesList(report.responses);

            $('#loadingSpinner').hide();
            $('#reportContainer').show();
        }

        function displayQuestionStats(questionStats) {
            const container = $('#questionStatsContainer');
            container.empty();

            questionStats.forEach((question, index) => {
                const chartId = `chart_${index}`;
                const questionHtml = `
                    <div class="mb-4">
                        <h6>${question.questionContent}</h6>
                        <div class="row">
                            <div class="col-md-8">
                                <canvas id="${chartId}" width="400" height="200"></canvas>
                            </div>
                            <div class="col-md-4">
                                <div class="mt-3">
                                    ${question.stats.map(stat => `
                                        <div class="d-flex justify-content-between">
                                            <span>${stat.option}</span>
                                            <span class="fw-bold">${stat.count} (${stat.percentage}%)</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.append(questionHtml);

                if (question.type !== 'Text') {
                    createChart(chartId, question);
                }
            });
        }

        function createChart(chartId, question) {
            const ctx = document.getElementById(chartId).getContext('2d');

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: question.stats.map(stat => stat.option),
                    datasets: [{
                        data: question.stats.map(stat => stat.count),
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF',
                            '#FF9F40'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function displayResponsesList(responses) {
            const tbody = $('#responsesTableBody');
            tbody.empty();

            responses.forEach((response, index) => {
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${response.userName}</td>
                        <td>${formatDateTime(response.completedDate)}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewUserResponse(${response.responseId})">
                                <i class="fas fa-eye"></i> Xem chi tiết
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function viewUserResponse(responseId) {
            window.open(`@Url.Action("ViewResponse", "Surveys")?id=${responseId}`, '_blank');
        }

        function exportToExcel() {
            const surveyId = @surveyId;
            window.location.href = `@Url.Action("ExportSurveyResults", "Surveys")?id=${surveyId}`;
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
}