@{
    ViewData["Title"] = "Tổng hợp kết quả khảo sát";
}

<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-chart-line"></i> Tổng hợp kết quả khảo sát</h2>
            <div>
                <button type="button" class="btn btn-success me-2" onclick="exportAllResults()">
                    <i class="fas fa-file-excel"></i> Xuất tất cả
                </button>
                <a href="@Url.Action("Index", "Surveys")" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Quay lại
                </a>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center bg-primary text-white">
                    <div class="card-body">
                        <h3 id="totalSurveys">0</h3>
                        <p class="mb-0">Tổng khảo sát</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-success text-white">
                    <div class="card-body">
                        <h3 id="activeSurveys">0</h3>
                        <p class="mb-0">Đang hoạt động</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-info text-white">
                    <div class="card-body">
                        <h3 id="totalResponses">0</h3>
                        <p class="mb-0">Tổng phản hồi</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-warning text-white">
                    <div class="card-body">
                        <h3 id="uniqueUsers">0</h3>
                        <p class="mb-0">Người tham gia</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-filter"></i> Bộ lọc</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Khảo sát</label>
                        <select class="form-select" id="surveyFilter">
                            <option value="">Tất cả khảo sát</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Đối tượng</label>
                        <select class="form-select" id="audienceFilter">
                            <option value="">Tất cả đối tượng</option>
                            <option value="Học sinh">Học sinh</option>
                            <option value="Phụ huynh">Phụ huynh</option>
                            <option value="Giáo viên">Giáo viên</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Từ ngày</label>
                        <input type="date" class="form-control" id="fromDate">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Đến ngày</label>
                        <input type="date" class="form-control" id="toDate">
                    </div>
                </div>
                <div class="mt-3">
                    <button type="button" class="btn btn-primary" onclick="applyFilters()">
                        <i class="fas fa-search"></i> Áp dụng lọc
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                        <i class="fas fa-times"></i> Xóa lọc
                    </button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-table"></i> Danh sách khảo sát và kết quả</h5>
            </div>
            <div class="card-body">
                <div id="loadingSpinner" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                </div>

                <div class="table-responsive" id="resultsTable" style="display: none;">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Tên khảo sát</th>
                                <th>Đối tượng</th>
                                <th>Trạng thái</th>
                                <th>Lượt làm</th>
                                <th>Hoàn thành</th>
                                <th>Tỷ lệ (%)</th>
                                <th>Cập nhật cuối</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                        </tbody>
                    </table>
                </div>

                <nav aria-label="Phân trang">
                    <ul class="pagination justify-content-center" id="pagination">
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="quickStatsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Thống kê nhanh</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="quickStatsContent">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="viewDetailedReport">Xem báo cáo chi tiết</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let currentPage = 1;
        let pageSize = 10;
        let selectedSurveyId = null;

        $(document).ready(function() {
            loadOverviewStats();
            loadSurveysList();
            loadAllResults();
        });

        function loadOverviewStats() {
            getAllSurveyStats();
        }

        function loadSurveysList() {
            getSurveysForFilter();
        }

        function populateSurveyFilter(surveys) {
            const select = $('#surveyFilter');
            select.empty().append('<option value="">Tất cả khảo sát</option>');

            surveys.forEach(survey => {
                select.append(`<option value="${survey.surveyId}">${survey.name}</option>`);
            });
        }

        function displayOverviewStats(stats) {
            $('#totalSurveys').text(stats.totalSurveys);
            $('#activeSurveys').text(stats.activeSurveys);
            $('#totalResponses').text(stats.totalResponses);
            $('#uniqueUsers').text(stats.uniqueUsers);
        }

        function loadAllResults() {
            const filters = {
                surveyId: $('#surveyFilter').val(),
                targetAudience: $('#audienceFilter').val(),
                fromDate: $('#fromDate').val(),
                toDate: $('#toDate').val(),
                page: currentPage,
                pageSize: pageSize
            };

            getAllSurveyResults(filters);
        }

        function displayAllResults(results) {
            const tbody = $('#resultsTableBody');
            tbody.empty();

            results.surveys.forEach(survey => {
                const statusClass = survey.status === 'Active' ? 'bg-success' : 'bg-secondary';
                const statusText = survey.status === 'Active' ? 'Hoạt động' : 'Dừng';
                const completionRate = survey.totalResponses > 0 ?
                    Math.round((survey.completedResponses / survey.totalResponses) * 100) : 0;

                const row = `
                    <tr>
                        <td>
                            <strong>${survey.name}</strong>
                            <br>
                            <small class="text-muted">${survey.description || ''}</small>
                        </td>
                        <td>${survey.targetAudiences}</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td>${survey.totalResponses}</td>
                        <td>${survey.completedResponses}</td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar" role="progressbar" style="width: ${completionRate}%">
                                    ${completionRate}%
                                </div>
                            </div>
                        </td>
                        <td>${formatDate(survey.updatedDate)}</td>
                        <td>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-info" onclick="showQuickStats(${survey.surveyId}, '${survey.name}')">
                                    <i class="fas fa-chart-pie"></i>
                                </button>
                                <a href="@Url.Action("Result", "Surveys")?id=${survey.surveyId}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-chart-bar"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-success" onclick="exportSurveyResults(${survey.surveyId})">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });

            updatePagination(results.totalPages, results.currentPage);

            $('#loadingSpinner').hide();
            $('#resultsTable').show();
        }

        function showQuickStats(surveyId, surveyName) {
            selectedSurveyId = surveyId;
            $('.modal-title').text(`Thống kê nhanh - ${surveyName}`);

            getSurveyQuickStats(surveyId);
            $('#quickStatsModal').modal('show');
        }

        function displayQuickStats(stats) {
            const content = $('#quickStatsContent');
            content.html(`
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="card text-center">
                            <div class="card-body">
                                <h4 class="text-primary">${stats.totalResponses}</h4>
                                <p class="mb-0">Tổng phản hồi</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card text-center">
                            <div class="card-body">
                                <h4 class="text-success">${stats.averageTime} phút</h4>
                                <p class="mb-0">Thời gian trung bình</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <h6>Phân bố theo đối tượng:</h6>
                        <canvas id="audienceChart" width="400" height="200"></canvas>
                    </div>
                </div>
            `);

            if (stats.audienceDistribution && stats.audienceDistribution.length > 0) {
                createAudienceChart(stats.audienceDistribution);
            }
        }

        function createAudienceChart(data) {
            const ctx = document.getElementById('audienceChart').getContext('2d');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(item => item.audience),
                    datasets: [{
                        label: 'Số lượng phản hồi',
                        data: data.map(item => item.count),
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function applyFilters() {
            currentPage = 1;
            loadAllResults();
        }

        function clearFilters() {
            $('#surveyFilter').val('');
            $('#audienceFilter').val('');
            $('#fromDate').val('');
            $('#toDate').val('');
            currentPage = 1;
            loadAllResults();
        }

        function exportSurveyResults(surveyId) {
            window.location.href = `@Url.Action("ExportSurveyResults", "Surveys")?id=${surveyId}`;
        }

        function exportAllResults() {
            const filters = {
                surveyId: $('#surveyFilter').val(),
                targetAudience: $('#audienceFilter').val(),
                fromDate: $('#fromDate').val(),
                toDate: $('#toDate').val()
            };

            const queryString = Object.keys(filters)
                .filter(key => filters[key])
                .map(key => `${key}=${encodeURIComponent(filters[key])}`)
                .join('&');

            window.location.href = `@Url.Action("ExportAllResults", "Surveys")?${queryString}`;
        }

        function updatePagination(totalPages, currentPageNum) {
            const pagination = $('#pagination');
            pagination.empty();

            if (totalPages <= 1) return;

            if (currentPageNum > 1) {
                pagination.append(`
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePage(${currentPageNum - 1})">Trước</a>
                    </li>
                `);
            }

            for (let i = Math.max(1, currentPageNum - 2); i <= Math.min(totalPages, currentPageNum + 2); i++) {
                const activeClass = i === currentPageNum ? 'active' : '';
                pagination.append(`
                    <li class="page-item ${activeClass}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `);
            }

            if (currentPageNum < totalPages) {
                pagination.append(`
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePage(${currentPageNum + 1})">Sau</a>
                    </li>
                `);
            }
        }

        function changePage(page) {
            currentPage = page;
            loadAllResults();
        }

        $('#viewDetailedReport').click(function() {
            if (selectedSurveyId) {
                window.location.href = `@Url.Action("Result", "Surveys")?id=${selectedSurveyId}`;
            }
        });

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN');
        }
    </script>
}