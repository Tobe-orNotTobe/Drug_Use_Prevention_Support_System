@using BusinessObjects.Constants
@using BusinessObjects.Extensions
@{
    ViewData["Title"] = "Quản lý người dùng";
}

<!-- Only Admin can access this page -->
<div asp-authorize="@Roles.AdminOnly">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center bg-danger text-white">
                        <h3 class="card-title">
                            <i class="fas fa-users"></i> Quản lý người dùng
                        </h3>
                        <div>
                            <button type="button" class="btn btn-light" data-bs-toggle="modal" data-bs-target="#addUserModal">
                                <i class="fas fa-plus"></i> Thêm người dùng
                            </button>
                            <button type="button" class="btn btn-outline-light" onclick="exportUsers()">
                                <i class="fas fa-download"></i> Xuất dữ liệu
                            </button>
                        </div>
                    </div>

                    <div class="card-body">
                        <!-- Filters -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm người dùng...">
                            </div>
                            <div class="col-md-2">
                                <select id="roleFilter" class="form-select">
                                    <option value="">Tất cả vai trò</option>
                                    <option value="Member">Member</option>
                                    <option value="Staff">Staff</option>
                                    <option value="Consultant">Consultant</option>
                                    <option value="Manager">Manager</option>
                                    <option value="Admin">Admin</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select id="statusFilter" class="form-select">
                                    <option value="">Tất cả trạng thái</option>
                                    <option value="true">Hoạt động</option>
                                    <option value="false">Bị khóa</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <input type="date" id="dateFromFilter" class="form-control" placeholder="Từ ngày">
                            </div>
                            <div class="col-md-2">
                                <input type="date" id="dateToFilter" class="form-control" placeholder="Đến ngày">
                            </div>
                            <div class="col-md-1">
                                <button id="searchBtn" class="btn btn-primary w-100">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Statistics Cards -->
                        <div class="row mb-4">
                            <div class="col-md-2">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h6>Tổng số</h6>
                                        <h4 id="totalUsers">-</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h6>Members</h6>
                                        <h4 id="totalMembers">-</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h6>Staff</h6>
                                        <h4 id="totalStaff">-</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="card bg-warning text-white">
                                    <div class="card-body text-center">
                                        <h6>Consultants</h6>
                                        <h4 id="totalConsultants">-</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="card bg-secondary text-white">
                                    <div class="card-body text-center">
                                        <h6>Managers</h6>
                                        <h4 id="totalManagers">-</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="card bg-dark text-white">
                                    <div class="card-body text-center">
                                        <h6>Admins</h6>
                                        <h4 id="totalAdmins">-</h4>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Loading Spinner -->
                        <div id="loadingSpinner" class="text-center" style="display: none;">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>

                        <!-- Users Table -->
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Thông tin cá nhân</th>
                                        <th>Email</th>
                                        <th>Vai trò</th>
                                        <th>Trạng thái</th>
                                        <th>Ngày tạo</th>
                                        <th>Lần đăng nhập cuối</th>
                                        <th>Hành động</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Data will be loaded here via AJAX -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <nav aria-label="Page navigation">
                            <ul class="pagination justify-content-center" id="pagination">
                                <!-- Pagination will be generated here -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm người dùng mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="fullName" class="form-label">Họ và tên <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="fullName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control" id="email" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="phoneNumber" class="form-label">Số điện thoại</label>
                                    <input type="tel" class="form-control" id="phoneNumber">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="dateOfBirth" class="form-label">Ngày sinh</label>
                                    <input type="date" class="form-control" id="dateOfBirth">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="role" class="form-label">Vai trò <span class="text-danger">*</span></label>
                                    <select class="form-select" id="role" required>
                                        <option value="">Chọn vai trò</option>
                                        <option value="Member">Member</option>
                                        <option value="Staff">Staff</option>
                                        <option value="Consultant">Consultant</option>
                                        <option value="Manager">Manager</option>
                                        <option value="Admin">Admin</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="isActive" class="form-label">Trạng thái</label>
                                    <select class="form-select" id="isActive">
                                        <option value="true">Hoạt động</option>
                                        <option value="false">Bị khóa</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Mật khẩu tạm thời <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="password" required>
                            <div class="form-text">Người dùng sẽ được yêu cầu đổi mật khẩu khi đăng nhập lần đầu</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="addUser()">Thêm người dùng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chỉnh sửa người dùng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editFullName" class="form-label">Họ và tên <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editFullName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editEmail" class="form-label">Email <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control" id="editEmail" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editPhoneNumber" class="form-label">Số điện thoại</label>
                                    <input type="tel" class="form-control" id="editPhoneNumber">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editDateOfBirth" class="form-label">Ngày sinh</label>
                                    <input type="date" class="form-control" id="editDateOfBirth">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editRole" class="form-label">Vai trò <span class="text-danger">*</span></label>
                                    <select class="form-select" id="editRole" required>
                                        <option value="Member">Member</option>
                                        <option value="Staff">Staff</option>
                                        <option value="Consultant">Consultant</option>
                                        <option value="Manager">Manager</option>
                                        <option value="Admin">Admin</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editIsActive" class="form-label">Trạng thái</label>
                                    <select class="form-select" id="editIsActive">
                                        <option value="true">Hoạt động</option>
                                        <option value="false">Bị khóa</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="resetPassword">
                                <label class="form-check-label" for="resetPassword">
                                    Reset mật khẩu về mặc định
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="updateUser()">Cập nhật</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Pass user permissions to JavaScript
        window.USER_PERMISSIONS = {
            canManageUsers: @(User.CanManageUsers().ToString().ToLower()),
            isAdmin: @(User.IsAdmin().ToString().ToLower()),
            userRole: '@User.GetHighestRole()'
        };
    </script>
    <script src="~/js/users-management.js" asp-append-version="true"></script>
}